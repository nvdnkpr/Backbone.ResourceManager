/*!
* Backbone.ResourceManager - v0.1.0 - 2013-01-29
* https://github.com/HubSpot/Backbone.ResourceManager
* Copyright (c) 2013 HubSpot, Matthew Pirkowski;
* Licensed MIT 
*/
(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p=[].slice,d=function(e,t){return function(){return e.apply(t,arguments)}},v={}.hasOwnProperty,m=function(e,t){function r(){this.constructor=e}for(var n in t)v.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};l=typeof global=="object"?global:this,t=l.Backbone,c=l._,e=l.$||l.jQuery,a=function(){function t(){}var e;return e=void 0,t.getInstance=function(){var t;return t=1<=arguments.length?p.call(arguments,0):[],e!=null?e:e=function(e,t,n){n.prototype=e.prototype;var r=new n,i=e.apply(r,t),s=typeof i;return s=="object"||s=="function"?i||r:r}(h,t,function(){})},t}(),h=function(){function r(){var e;e=1<=arguments.length?p.call(arguments,0):[],this.addConfigs=d(this.addConfigs,this),this.init=d(this.init,this),this.sync=d(this.sync,this),this._resolveSubPromises=d(this._resolveSubPromises,this),this._generateSubPromises=d(this._generateSubPromises,this),this.gets=d(this.gets,this),this.get=d(this.get,this);return}var n=this;return r.prototype.managedViews={},r.prototype.collectionIdMaps={},r.prototype.out={},r.prototype.errors={},r.prototype.get=function(n,r){var i,s,o,u,a,f,l,h,p,d,v,m=this;return s=e.Deferred(),v={},u=""+n.name+":"+n.id,d=this.out[u],i=this.caching.get(u),c.isFunction(n.bootstrapData)&&!n.bootstrapped&&(i=n.bootstrapData(),n.bootstrapped=!0),h=c.filter(n.attributes,function(e,t){return(e!=null?e.attributes:void 0)!=null||(e!=null?e.models:void 0)!=null}),p=h.length?this._generateSubPromises(h,r):void 0,d?a=d:a=t.sync("read",n,r).done(function(e){return delete m.out[u],m.caching.set(u,e)}),this.out[u]=a,typeof i!="undefined"?(c.each(i,function(e,t){if(n.get(t)!==e)return v[t]=e}),(p!=null?p.length:void 0)?(l=function(){return s.resolve(v)},this._resolveSubPromises(p,l,s.reject,r)):s.resolve(v)):(f=function(e){return s.reject({resource:n,response:e,options:r,deferred:s})},(p!=null?p.length:void 0)?(a.name=n.name,p.push(a),this._resolveSubPromises(p,s.resolve,f,r)):a.done(s.resolve).fail(f)),o=s.promise(),o.name=n.name,o},r.prototype.gets=function(n,r){var i,s,o,u,a,f,l,h,p,d=this;return s=e.Deferred(),f=this.collectionIdMaps[n.name],a=r.idAttr||"id",i=""+n.name,s.key=i,p=this.out[i],c.isFunction(n.bootstrapFrom)&&(o=n.bootstrapFrom(),this.collectionIdMaps[n.name]=c.pluck(o,a),s.resolve(o)),p?l=p:l=t.sync("read",n,r).done(function(e){n.each(function(e){var t;return t=""+e.name+":"+e.id,d.caching.set(t,e.attributes)}),d.collectionIdMaps[n.name]=n.pluck(a);if(!r.add)return n.reset(e)}),this.out[i]=l,typeof f!="undefined"&&f.length?s.resolve(c.map(f,function(e){var t,r;return r=""+n.model.prototype.name+":"+e,t=d.caching.get(r),t.instanceId=e,t})):(h=function(e){return s.reject({resource:n,response:e,options:r,deferred:s})},l.done(s.resolve).fail(h)),u=s.promise(),u.name=n.name,u},r.prototype.create=function(e,n){return t.sync("read",e,n).done(function(e){var t,n=this;t=""+e.name+":"+e.id,this.caching.set(t,e.attributes);if(e.collection)return collection.each(function(e){return t=""+e.name+":"+e.id,n.caching.set(t,e.attributes)}),this.collectionIdMaps[e.name]=e.collection.pluck(idAttr)}).promise()},r.prototype.update=function(e,n){var r,i,s,o=this;return i=""+e.name+":"+e.id,r=this.caching.get(i),s=r?c.clone(r):null,r=e.attributes,t.sync("update",e,n).done(function(e){var t;i=""+e.name+":"+e.id,t=o.caching.get(i);if(!t)return o.caching.set(i,e)}).fail(function(e){return s?r=s:o.caching.remove(i)}).promise()},r.prototype.destroy=function(e,n){var r,i,s;return i=""+e.name+":"+e.id,r=this.caching.get(i),s=r?c.clone(r):null,r=e.attributes,t.sync("delete",e,n).done(function(e){var t=this;i=""+e.name+":"+e.id,this.caching.remove(i);if(e.collection)return collection.each(function(e){return i=""+e.name+":"+e.id,t.caching.remove(i)}),delete this.collectionIdMaps[e.name]}).fail(function(e){s&&(r=s)}).promise()},r.prototype._generateSubPromises=function(e,t){var n=this;return c.map(e,function(e){return e.fetch()})},r.prototype._resolveSubPromises=function(t,n,r,i){var s=this;return e.when.apply(this,t).done(function(){return n()}).fail(function(e){return t=c(t).reject(function(t){return t.name===e.resource.name}),s._resolveSubPromises(t,n,r,i)})},r.prototype.sync=function(e,t,n){var r;n=c.defaults(n,{});switch(e){case"read":r=typeof t.id!="undefined"?this.get(t,n):this.gets(t,n);break;case"create":r=this.create(t,n);break;case"update":r=this.update(t,n);break;case"delete":r=this.destroy(t,n)}return r},r.prototype.init=function(e){var t,n;return t={configs:[],caching:{"interface":null,ttl:"forever",purge_frequency:"never",ns:"instanceStore"}},e=c.extend({},t,e),e.caching["interface"]!=null&&(this.prototype.caching=e.caching["interface"]),this.caching.init(e.caching.ns,e.caching.ttl,e.caching.purge_frequency),e.configs!=null&&(n=this.addConfigs(e.configs)),this.renderDeferredViews(n)},r.prototype.addConfigs=function(e){var t,n,r,i;n=[];for(r in e)t=e[r],i=this.managedViews[r]={},i.view=new t.view,i.view.requires=t.deps,n.push(i.view.resolveDeps());return n},r.prototype.renderDeferredViews=function(e){var t,n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(t.deferredRender());return i},r.prototype.caching={init:function(e,t,n){var i;t==null&&(t="forever"),n==null&&(n="never"),r.prototype.cachingNamespace=e,r.prototype[e]={};if(t!=="forever"){if(n==="never")throw new Error("A purge_frequency (specified in seconds) must be provided when using a default_ttl");return i=r,setInterval(function(){return i.prototype.caching.purge.call(i,t)},n)}},get:function(e){return r.prototype[r.prototype.cachingNamespace][e]},set:function(e,t){var n,i;return n=r.prototype.cachingNamespace,i=(new Date).getTime()/1e3,t._rmCreatedAt=i,r.prototype[n][e]=t,t},remove:function(e){return delete r.prototype[r.prototype.cachingNamespace][e]},purge:function(e){var t,n,i,s,o;i=(new Date).getTime()/1e3,s=r.prototype[r.prototype.cachingNamespace],o=[];for(n in s)t=s[n],t._rmCreatedAt+e<i?o.push(r.prototype.caching.remove(n)):o.push(void 0);return o}},r}.call(this),f=function(){var e,t,n,r,i,s,o;n=1<=arguments.length?p.call(arguments,0):[];if(!(n&&n.length>0))throw new Error("include(mixins...) requires at least one mixin");for(i=0,s=n.length;i<s;i++){t=n[i];for(e in t)r=t[e],e!=="included"&&(this.prototype[e]=r);(o=t.included)!=null&&o.apply(this)}return this},t.Model._rmInclude=t.Collection._rmInclude=f,t.View._rmInclude=t.Router._rmInclude=f,s={included:function(){return this.prototype.name="managedmodel"},sync:function(e,n,r){return t.rm.ResourceManager.sync(e,n,r)},toJSON:function(e){var t,n,r,i;t=c.clone(this.attributes),i=this.attributes;for(n in i){r=i[n];if(r!=null?r.attributes:void 0)t[n]=r.toJSON()}return t}},r={included:function(){return this.prototype.name="managedcollection"},sync:function(e,n,r){return t.rm.ResourceManager.sync(e,n,r)}},u={included:function(){return this.prototype.name="managedview-default",this.prototype.requires=[],this.prototype.managedDeps={}},rmDeferredInit:function(){},resolveDeps:function(){var t,n,r,i=this;return t=e.Deferred(),n=this.mappedFetch(),r=function(){return i.rmDeferredInit(),t.resolve(),i._setupPolling()},this._resolveRequiredPromises(n,r,t.reject),this.depsDeferred=t,this},_setupPolling:function(){var e,t,n,r,i=this;n=this.requires,r=[];for(e in n)t=n[e],t.polling?r.push(setInterval(function(){return i.managedDeps[t["class"].prototype.name].fetch()},t.pollingInterval||1e4)):r.push(void 0);return r},mappedFetch:function(){var e=this;return c.map(this._getConfig(),function(t){var n,r;return n=e.managedDeps[t["class"].prototype.name],n||(n=t.id?new t["class"]({id:t.id}):new t["class"],c.isFunction(t.bootstrapData)&&(n.bootstrapData=t.bootstrapData,n.bootstrapped=!1),e.managedDeps[n.name]=n),r=n.models?"collection":"model",t.assign!==!1&&(e[r]=n),n.fetch()})},_getConfig:function(){if(this.requires.length)return this.requires;throw"You must provide a dependency configuration for the "+this.name+" view"},_resolveRequiredPromises:function(t,n,r,i){var s=this;return e.when.apply(this,t).done(function(){return n()}).fail(function(e){return c.isFunction(e.resource.error)&&e.resource.error(e.resource,e.response,e.options),t=c(t).reject(function(t){return t.name===e.resource.name}),s._resolveRequiredPromises(t,n,r,i)})},render:function(e,t){return this.$el.html(e(t))},deferredRender:function(e,t,n){var r=this;return e==null&&(e=this.depsDeferred),t==null&&(t=this.template),n==null&&(n={}),n=c.defaults({},n),n.data={},e.done(function(){var e,i,s;s=r.managedDeps;for(e in s)i=s[e],n.data[e]=i.toJSON();return r.render(t,n)})}},i=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return m(t,e),t._rmInclude(s),t}(t.Model),n=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return m(t,e),t._rmInclude(r),t}(t.Collection),o=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return m(t,e),t._rmInclude(u),t}(t.View),t.rm={},t.rm.ResourceManager=a.getInstance(),t.rm.ManagedModelMixin=s,t.rm.ManagedCollectionMixin=r,t.rm.ManagedViewMixin=u,t.rm.ManagedModel=i,t.rm.ManagedCollection=n,t.rm.ManagedView=o}).call(this);